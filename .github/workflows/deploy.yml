name: Deploy Landing Page

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manual trigger

env:
  NODE_VERSION: '20'
  PROJECT_ID: slimpim-landing-page

jobs:
  # Lint and test landing page
  test:
    name: Lint and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint
        run: npm run lint

      - name: Build (test)
        run: npm run build

  # Deploy to Firebase Hosting
  deploy:
    name: Deploy to Firebase Hosting
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Functions dependencies
        run: npm ci
        working-directory: ./functions

      - name: Build landing page
        run: npm run build
        env:
          VITE_GA_MEASUREMENT_ID: ${{ secrets.VITE_GA_MEASUREMENT_ID }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          VITE_APP_VERSION: ${{ github.ref_name }}
          VITE_GIT_COMMIT_HASH: ${{ github.sha }}
          VITE_BUILD_TIME: ${{ github.event.head_commit.timestamp }}

      - name: Build Functions
        run: npm run build
        working-directory: ./functions

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ env.PROJECT_ID }}

      - name: Create .env file for Firebase Functions
        run: |
          cat > functions/.env << EOF
          BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}
          BREVO_NOTIFY_ME_LIST_ID=${{ secrets.BREVO_NOTIFY_ME_LIST_ID }}
          BREVO_NEWSLETTER_LIST_ID=${{ secrets.BREVO_NEWSLETTER_LIST_ID }}
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          EMAIL_FROM_ADDRESS=${{ secrets.EMAIL_FROM_ADDRESS }}
          EMAIL_FROM_NAME=${{ secrets.EMAIL_FROM_NAME }}
          EOF

      - name: Deploy Functions to Firebase
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > $HOME/gcloud-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-key.json

          # Deploy v2 functions (reads .env file automatically)
          npx firebase-tools deploy --only functions \
            --project ${{ env.PROJECT_ID }} \
            --non-interactive \
            --force

  # Notify on success/failure
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          if [[ "${{ needs.test.result }}" == "success" && \
                "${{ needs.deploy.result }}" == "success" ]]; then
            echo "‚úÖ Landing page deployed successfully to Firebase!"
            echo "üåê Firebase Hosting: slimpim.ai"
            echo "‚ö° Firebase Functions: deployed"
          else
            echo "‚ùå Landing page deployment failed!"
            echo "Test: ${{ needs.test.result }}"
            echo "Deploy: ${{ needs.deploy.result }}"
            exit 1
          fi
